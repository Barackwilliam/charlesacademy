{% extends 'base.html' %}
{% block page_title %}Student Attendance Report{% endblock %}
{% block content %}
<div class="container-fluid px-2 px-sm-3">
    <!-- Header -->
    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-3 gap-2">
        <div class="flex-grow-1">
            <h1 class="fw-bold mb-1 fs-4 fs-md-3">Student Attendance Report</h1>
            <p class="text-muted mb-0 fs-6">Monthly attendance overview</p>
        </div>
        <div class="w-100 w-sm-auto">
            <button class="btn btn-outline-primary btn-sm d-block d-sm-inline-block" onclick="window.print()">
                <i class="bi bi-printer me-1"></i> <span>Print</span>
            </button>
        </div>
    </div>

    <!-- Filter Card -->
    <div class="card border-0 shadow-sm mb-3">
        <div class="card-body p-2 p-sm-3">
            <form method="GET" class="row g-2 align-items-end">
                <div class="col-12 col-sm-6 col-md-4">
                    <label class="form-label fw-medium fs-7">
                        <i class="bi bi-calendar-month me-1"></i> Month
                    </label>
                    <select name="month" class="form-select form-select-sm">
                        <option value="">All Months</option>
                        <option value="1" {% if month == '1' %}selected{% endif %}>Jan</option>
                        <option value="2" {% if month == '2' %}selected{% endif %}>Feb</option>
                        <option value="3" {% if month == '3' %}selected{% endif %}>Mar</option>
                        <option value="4" {% if month == '4' %}selected{% endif %}>Apr</option>
                        <option value="5" {% if month == '5' %}selected{% endif %}>May</option>
                        <option value="6" {% if month == '6' %}selected{% endif %}>Jun</option>
                        <option value="7" {% if month == '7' %}selected{% endif %}>Jul</option>
                        <option value="8" {% if month == '8' %}selected{% endif %}>Aug</option>
                        <option value="9" {% if month == '9' %}selected{% endif %}>Sep</option>
                        <option value="10" {% if month == '10' %}selected{% endif %}>Oct</option>
                        <option value="11" {% if month == '11' %}selected{% endif %}>Nov</option>
                        <option value="12" {% if month == '12' %}selected{% endif %}>Dec</option>
                    </select>
                </div>
                <div class="col-12 col-sm-6 col-md-4">
                    <label class="form-label fw-medium fs-7">
                        <i class="bi bi-building me-1"></i> Class
                    </label>
                    <select class="form-select form-select-sm" id="classFilter">
                        <option value="">All Classes</option>
                        <option value="Form 1">Form 1</option>
                        <option value="Form 2">Form 2</option>
                        <option value="Form 3">Form 3</option>
                        <option value="Form 4">Form 4</option>
                    </select>
                </div>
                <div class="col-12 col-sm-12 col-md-4">
                    <div class="d-flex gap-1 flex-wrap">
                        <button type="submit" class="btn btn-primary btn-sm flex-grow-1 flex-md-grow-0">
                            <i class="bi bi-funnel me-1"></i> Filter
                        </button>
                        <a href="{% url 'attendance:student_attendance_list' %}" class="btn btn-outline-secondary btn-sm flex-grow-1 flex-md-grow-0">
                            <i class="bi bi-arrow-clockwise me-1"></i> Reset
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Statistics Overview -->
    <div class="row row-cols-2 row-cols-sm-4 g-2 g-sm-3 mb-3">
        <div class="col">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="me-2">
                            <h6 class="text-muted mb-0 fs-7">Total</h6>
                            <h3 class="fw-bold mb-0 fs-5">{{ records|length }}</h3>
                        </div>
                        <div class="icon-wrapper bg-primary bg-opacity-10 rounded-circle p-1">
                            <i class="bi bi-clipboard-data text-primary fs-6"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="me-2">
                            <h6 class="text-muted mb-0 fs-7">Present</h6>
                            <h3 class="fw-bold mb-0 fs-5" id="presentCount">0</h3>
                        </div>
                        <div class="icon-wrapper bg-success bg-opacity-10 rounded-circle p-1">
                            <i class="bi bi-check-circle text-success fs-6"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="me-2">
                            <h6 class="text-muted mb-0 fs-7">Absent</h6>
                            <h3 class="fw-bold mb-0 fs-5" id="absentCount">0</h3>
                        </div>
                        <div class="icon-wrapper bg-danger bg-opacity-10 rounded-circle p-1">
                            <i class="bi bi-x-circle text-danger fs-6"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="me-2">
                            <h6 class="text-muted mb-0 fs-7">Rate</h6>
                            <h3 class="fw-bold mb-0 fs-5" id="attendanceRate">0%</h3>
                        </div>
                        <div class="icon-wrapper bg-info bg-opacity-10 rounded-circle p-1">
                            <i class="bi bi-percent text-info fs-6"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Table -->
    <div class="card border-0 shadow-sm overflow-hidden">
        <div class="card-header bg-white border-0 py-2">
            <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2">
                <div class="flex-grow-1">
                    <h5 class="mb-0 fw-bold fs-6">
                        <i class="bi bi-table text-primary me-1"></i>
                        Attendance Records
                        {% if month %}
                            <small class="text-muted fs-7">- Month {{ month }}</small>
                        {% endif %}
                    </h5>
                </div>
                <div class="d-flex gap-1 w-100 w-sm-auto">
                    <button class="btn btn-outline-secondary btn-sm flex-grow-1 flex-sm-grow-0" id="exportBtn">
                        <i class="bi bi-download me-1"></i> <span class="d-none d-sm-inline">Export</span>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="attendanceTable">
                    <thead class="table-light d-none d-sm-table-header-group">
                        <tr>
                            <th class="ps-3">Student</th>
                            <th class="d-none d-md-table-cell">Class</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th class="text-end pe-3" style="min-width: 70px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in records %}
                        <tr class="attendance-record" data-class="{{ r.student.classroom.name|default:'Unknown' }}">
                            <td class="ps-3" data-label="Student">
                                <div class="d-flex align-items-center">
                                    <div class="avatar bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center me-2 flex-shrink-0" 
                                         style="width: 32px; height: 32px;">
                                        {{ r.student.full_name|slice:":1"|upper }}
                                    </div>
                                    <div class="min-w-0">
                                        <h6 class="mb-0 fw-bold fs-6 text-truncate">{{ r.student.full_name }}</h6>
                                        <small class="text-muted fs-7 d-block text-truncate">{{ r.student.registration_number }}</small>
                                    </div>
                                </div>
                            </td>
                            <td class="d-none d-md-table-cell" data-label="Class">
                                <span class="badge bg-secondary fs-7">{{ r.student.classroom.name|default:"N/A" }}</span>
                            </td>
                            <td data-label="Date">
                                <span class="fw-medium fs-7 d-block">{{ r.date|date:"M d" }}</span>
                                <small class="text-muted fs-7">{{ r.date|date:"D" }}</small>
                            </td>
                            <td data-label="Status">
                                {% if r.status == 'PRESENT' or r.status == 'Present' %}
                                    <span class="badge bg-success rounded-pill px-2 py-1 fs-7">
                                        <i class="bi bi-check-circle me-1"></i> P
                                    </span>
                                {% elif r.status == 'ABSENT' or r.status == 'Absent' %}
                                    <span class="badge bg-danger rounded-pill px-2 py-1 fs-7">
                                        <i class="bi bi-x-circle me-1"></i> A
                                    </span>
                                {% elif r.status == 'LATE' or r.status == 'Late' %}
                                    <span class="badge bg-warning rounded-pill px-2 py-1 fs-7">
                                        <i class="bi bi-clock me-1"></i> L
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary rounded-pill px-2 py-1 fs-7">{{ r.status|slice:":1" }}</span>
                                {% endif %}
                            </td>
                            <td class="text-end pe-3" data-label="Actions">
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-info view-details px-2" data-id="{{ r.id }}">
                                        <i class="bi bi-eye fs-7"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-4">
                                <div class="py-3">
                                    <i class="bi bi-calendar-x display-6 text-muted"></i>
                                    <h5 class="mt-2 fs-5">No Records Found</h5>
                                    <p class="text-muted fs-6 mb-0">
                                        {% if month %}
                                            No records for selected month
                                        {% else %}
                                            No attendance records
                                        {% endif %}
                                    </p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Table Footer -->
        <div class="card-footer bg-white border-0 py-2">
            <div class="d-flex flex-column flex-sm-row justify-content-between align-items-center gap-2">
                <div class="order-2 order-sm-1">
                    <span class="text-muted fs-7">
                        Showing <span id="visibleCount">{{ records|length }}</span> records
                    </span>
                </div>
                <div class="order-1 order-sm-2">
                    <nav aria-label="Page navigation">
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item">
                                <a class="page-link" href="#" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Section -->
    {% if records %}
    <div class="row mt-3">
        <div class="col-lg-8 mb-3 mb-lg-0">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-2">
                    <h6 class="mb-0 fw-bold fs-6">
                        <i class="bi bi-bar-chart me-1 text-primary"></i>
                        Summary
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6 mb-3 mb-md-0">
                            <div class="chart-container" style="height: 180px;">
                                <canvas id="attendanceChart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3 bg-light rounded">
                                <h6 class="fw-bold mb-2 fs-6">Insights</h6>
                                <ul class="list-unstyled mb-0 fs-7">
                                    <li class="mb-2">
                                        <i class="bi bi-calendar-check text-success me-2"></i>
                                        <span>Rate: <strong id="performance">0%</strong></span>
                                    </li>
                                    <li>
                                        <i class="bi bi-info-circle text-info me-2"></i>
                                        <span>Generated: <strong>{{ today|date:"M d, Y" }}</strong></span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-2">
                    <h6 class="mb-0 fw-bold fs-6">
                        <i class="bi bi-info-circle me-1 text-info"></i>
                        Info
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <small class="text-muted d-block fs-7">Period</small>
                        <p class="fw-bold mb-0 fs-6">
                            {% if month %}
                                Month {{ month }} {{ current_year }}
                            {% else %}
                                All {{ current_year }}
                            {% endif %}
                        </p>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted d-block fs-7">System</small>
                        <p class="fw-bold mb-0 fs-6">Attendance System</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
    .min-w-0 { min-width: 0; }
    .avatar { font-weight: 600; font-size: 0.8rem; }
    
    @media (max-width: 576px) {
        .table-responsive { border: 0; }
        .table thead { display: none; }
        .table tbody tr { 
            display: block; 
            margin-bottom: 0.75rem; 
            border: 1px solid #dee2e6; 
            border-radius: 0.375rem;
            padding: 0.5rem;
        }
        .table tbody td { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0.375rem 0.25rem;
            border: none;
        }
        .table tbody td:before { 
            content: attr(data-label); 
            font-weight: 600; 
            margin-right: 0.5rem;
            font-size: 0.75rem;
            min-width: 40px;
        }
        .table tbody td .btn-group { width: 100%; justify-content: flex-end; }
        .attendance-record td:nth-child(1):before { content: "Student"; }
        .attendance-record td:nth-child(2):before { content: "Class"; }
        .attendance-record td:nth-child(3):before { content: "Date"; }
        .attendance-record td:nth-child(4):before { content: "Status"; }
        .attendance-record td:nth-child(5):before { content: "Actions"; }
        .badge { font-size: 0.65rem !important; }
    }
    
    @media (max-width: 768px) {
        .fs-6 { font-size: 0.875rem !important; }
        .fs-7 { font-size: 0.75rem !important; }
        .d-none.d-md-table-cell { display: none !important; }
        .chart-container { height: 150px !important; }
        .pagination .page-link { padding: 0.25rem 0.5rem; }
    }
    
    @media print {
        .btn, .form-control, .form-select, .card-header, .pagination {
            display: none !important;
        }
        .card { border: none !important; box-shadow: none !important; }
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Calculate stats on load
    calculateStats();
    
    // Class filter
    document.getElementById('classFilter')?.addEventListener('change', filterTable);
    
    // Export button
    document.getElementById('exportBtn')?.addEventListener('click', function() {
        const rows = [['Student', 'Reg Number', 'Class', 'Date', 'Status']];
        
        document.querySelectorAll('.attendance-record').forEach(record => {
            if (record.style.display !== 'none') {
                const student = record.querySelector('h6').textContent.trim();
                const reg = record.querySelector('small.text-muted').textContent.trim();
                const cls = record.querySelector('.badge.bg-secondary')?.textContent.trim() || 'N/A';
                const date = record.querySelector('td:nth-child(3) span').textContent.trim();
                const status = record.querySelector('.badge.rounded-pill').textContent.trim().charAt(0);
                
                rows.push([student, reg, cls, date, status]);
            }
        });
        
        const csv = rows.map(row => row.join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `attendance_${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    });
    
    // View details
    document.querySelectorAll('.view-details').forEach(btn => {
        btn.addEventListener('click', function() {
            alert('Record ID: ' + this.getAttribute('data-id'));
        });
    });
    
    // Initialize chart
    if (document.getElementById('attendanceChart')) {
        initChart();
    }
    
    // Setup mobile table
    if (window.innerWidth < 576) {
        document.querySelectorAll('.attendance-record td').forEach((td, idx) => {
            const labels = ['Student', 'Class', 'Date', 'Status', 'Actions'];
            if (labels[idx]) {
                td.setAttribute('data-label', labels[idx]);
            }
        });
    }
});

function calculateStats() {
    let present = 0, absent = 0, late = 0;
    
    document.querySelectorAll('.attendance-record').forEach(record => {
        const badge = record.querySelector('.badge');
        if (badge) {
            const cls = badge.className;
            if (cls.includes('bg-success')) present++;
            else if (cls.includes('bg-danger')) absent++;
            else if (cls.includes('bg-warning')) late++;
        }
    });
    
    const total = present + absent + late;
    const rate = total > 0 ? Math.round((present / total) * 100) : 0;
    
    document.getElementById('presentCount').textContent = present;
    document.getElementById('absentCount').textContent = absent;
    document.getElementById('attendanceRate').textContent = rate + '%';
    
    const perf = document.getElementById('performance');
    if (perf) {
        perf.textContent = rate + '%';
    }
}

function filterTable() {
    const filter = document.getElementById('classFilter').value;
    let visible = 0;
    
    document.querySelectorAll('.attendance-record').forEach(row => {
        const cls = row.getAttribute('data-class');
        const show = !filter || cls === filter;
        
        row.style.display = show ? '' : 'none';
        if (show) visible++;
    });
    
    document.getElementById('visibleCount').textContent = visible;
}

function initChart() {
    const ctx = document.getElementById('attendanceChart').getContext('2d');
    const present = parseInt(document.getElementById('presentCount').textContent) || 0;
    const absent = parseInt(document.getElementById('absentCount').textContent) || 0;
    const late = parseInt(document.querySelectorAll('.badge.bg-warning').length) || 0;
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Present', 'Absent', 'Late'],
            datasets: [{
                data: [present, absent, late],
                backgroundColor: ['#10b981', '#ef4444', '#f59e0b'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 10,
                        font: { size: 10 }
                    }
                }
            }
        }
    });
}

// Mobile resize handler
window.addEventListener('resize', function() {
    if (window.innerWidth < 576) {
        document.querySelectorAll('.attendance-record td').forEach((td, idx) => {
            const labels = ['Student', 'Class', 'Date', 'Status', 'Actions'];
            if (labels[idx]) {
                td.setAttribute('data-label', labels[idx]);
            }
        });
    }
});
</script>
{% endblock %}