{% extends 'base.html' %}
{% block page_title %}Add New Student{% endblock %}
{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="fw-bold mb-2">Register New Student</h1>
            <p class="text-muted mb-0">Fill in the student details below to register them in the system</p>
        </div>
        <div>
            <a href="{% url 'students:student_list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i> Back to Students
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Left Column - Form -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-lg">
                <div class="card-header bg-white border-0 py-3">
                    <h5 class="mb-0 fw-bold">
                        <i class="bi bi-person-plus-fill text-primary me-2"></i>
                        Student Information
                    </h5>
                </div>
                
                <div class="card-body p-4">
                    <form method="POST" id="studentForm" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <!-- Student Information Section -->
                        <div class="mb-4">
                            <h6 class="fw-bold mb-3 text-primary">
                                <i class="bi bi-person-badge me-2"></i>
                                Personal Details
                            </h6>
                            
                            <div class="row g-3">
                                <!-- Full Name -->
                                <div class="col-md-12">
                                    <label for="full_name" class="form-label fw-medium">
                                        <i class="bi bi-person me-1"></i> Full Name
                                        <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-white">
                                            <i class="bi bi-person text-muted"></i>
                                        </span>
                                        <input type="text" 
                                               name="full_name" 
                                               id="full_name"
                                               class="form-control" 
                                               placeholder="Enter student's full name"
                                               required
                                               autofocus>
                                        <div class="invalid-feedback">
                                            Please enter the student's full name.
                                        </div>
                                    </div>
                                    <small class="text-muted mt-1 d-block">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Enter the student's complete name (First Name Middle Name Last Name)
                                    </small>
                                </div>
                                
                                <!-- Email (REQUIRED) -->
                                <div class="col-md-12">
                                    <label for="email" class="form-label fw-medium">
                                        <i class="bi bi-envelope me-1"></i> Email Address
                                        <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-white">
                                            <i class="bi bi-envelope text-muted"></i>
                                        </span>
                                        <input type="email" 
                                               name="email" 
                                               id="email"
                                               class="form-control" 
                                               placeholder="student@example.com"
                                               required>
                                        <div class="invalid-feedback">
                                            Please enter a valid email address.
                                        </div>
                                    </div>
                                    <small class="text-muted mt-1 d-block">
                                        <i class="bi bi-exclamation-triangle me-1"></i>
                                        Credentials will be sent to this email
                                    </small>
                                </div>
                                
                                <!-- Email Preview (Auto-generated username and password) -->
                                <div class="col-md-12">
                                    <div class="alert alert-info p-3">
                                        <h6 class="fw-bold mb-2">
                                            <i class="bi bi-key me-1"></i> Auto-generated Credentials
                                        </h6>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <small class="text-muted d-block">Username will be:</small>
                                                <code class="d-block p-2 bg-light rounded mt-1" id="usernamePreview">
                                                    Registration Number
                                                </code>
                                            </div>
                                            <div class="col-md-6">
                                                <small class="text-muted d-block">Password will be:</small>
                                                <code class="d-block p-2 bg-light rounded mt-1" id="passwordPreview">
                                                    firstname@123
                                                </code>
                                            </div>
                                        </div>
                                        <small class="text-muted mt-2 d-block">
                                            <i class="bi bi-info-circle me-1"></i>
                                            These credentials will be emailed to the student
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Academic Information Section -->
                        <div class="mb-4">
                            <h6 class="fw-bold mb-3 text-primary">
                                <i class="bi bi-mortarboard me-2"></i>
                                Academic Information
                            </h6>
                            
                            <div class="row g-3">
                                <!-- Classroom Selection -->
                                <div class="col-md-6">
                                    <label for="classroom" class="form-label fw-medium">
                                        <i class="bi bi-building me-1"></i> Class/Form
                                        <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-white">
                                            <i class="bi bi-building text-muted"></i>
                                        </span>
                                        <select name="classroom" 
                                                id="classroom" 
                                                class="form-select" 
                                                required>
                                            <option value="" selected disabled>Select a class</option>
                                            {% for c in classes %}
                                                <option value="{{ c.id }}">{{ c.name }} ({{ c.code }})</option>
                                            {% empty %}
                                                <option value="" disabled>No classes available</option>
                                            {% endfor %}
                                        </select>
                                        <div class="invalid-feedback">
                                            Please select a class for the student.
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Admission Year -->
                                <div class="col-md-6">
                                    <label for="admission_year" class="form-label fw-medium">
                                        <i class="bi bi-calendar-check me-1"></i> Admission Year
                                        <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-white">
                                            <i class="bi bi-calendar-check text-muted"></i>
                                        </span>
                                        <select name="admission_year" 
                                                id="admission_year" 
                                                class="form-select" 
                                                required>
                                            <option value="" selected disabled>Select year</option>
                                            {% for year in years %}
                                                <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>
                                                    {{ year }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                        <div class="invalid-feedback">
                                            Please select admission year.
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Status Selection -->
                                <div class="col-md-6">
                                    <label for="status" class="form-label fw-medium">
                                        <i class="bi bi-info-circle me-1"></i> Student Status
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-white">
                                            <i class="bi bi-info-circle text-muted"></i>
                                        </span>
                                        <select name="status" id="status" class="form-select">
                                            <option value="ACTIVE" selected>Active</option>
                                            <option value="GRADUATED">Graduated</option>
                                            <option value="TRANSFERRED">Transferred</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Documents (Optional) -->
                                <div class="col-md-6">
                                    <label for="documents" class="form-label fw-medium">
                                        <i class="bi bi-file-earmark me-1"></i> Documents (Optional)
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-white">
                                            <i class="bi bi-paperclip text-muted"></i>
                                        </span>
                                        <input type="file" 
                                               name="documents" 
                                               id="documents"
                                               class="form-control"
                                               accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                                    </div>
                                    <small class="text-muted mt-1 d-block">
                                        Upload admission documents (PDF, Word, Images)
                                    </small>
                                </div>
                                
                                <!-- Photo (Optional) -->
                                <div class="col-md-12">
                                    <label for="photo" class="form-label fw-medium">
                                        <i class="bi bi-camera me-1"></i> Student Photo (Optional)
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-white">
                                            <i class="bi bi-image text-muted"></i>
                                        </span>
                                        <input type="file" 
                                               name="photo" 
                                               id="photo"
                                               class="form-control"
                                               accept="image/*">
                                    </div>
                                    <small class="text-muted mt-1 d-block">
                                        Recommended size: 200x200 pixels, max 2MB
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Generated Registration Number Preview -->
                        <div class="mb-4">
                            <div class="alert alert-warning">
                                <h6 class="fw-bold mb-2">
                                    <i class="bi bi-123 me-1"></i> Registration Number Information
                                </h6>
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>
                                        <small class="text-muted d-block">Registration number will be auto-generated:</small>
                                        <code class="d-block p-2 bg-light rounded mt-1 fs-5" id="registrationPreview">
                                            CA/CLASS/YEAR/0001
                                        </code>
                                    </div>
                                    <button type="button" id="generateRegBtn" class="btn btn-outline-secondary btn-sm">
                                        <i class="bi bi-arrow-repeat me-1"></i> Refresh Preview
                                    </button>
                                </div>
                                <small class="text-muted mt-2 d-block">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Format: CA/ClassCode/Year/Sequence
                                </small>
                            </div>
                        </div>
                        
                        <!-- Email Notification Toggle -->
                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" 
                                       id="sendEmailToggle" name="send_email" checked>
                                <label class="form-check-label fw-medium" for="sendEmailToggle">
                                    <i class="bi bi-envelope-check me-1"></i> Send credentials email to student
                                </label>
                                <div class="form-text">
                                    When checked, login credentials will be sent to the student's email
                                </div>
                            </div>
                        </div>
                        
                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between align-items-center mt-5 pt-3 border-top">
                            <div>
                                <button type="reset" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-clockwise me-1"></i> Reset Form
                                </button>
                            </div>
                            <div class="d-flex gap-2">
                                <a href="{% url 'students:student_list' %}" class="btn btn-outline-danger">
                                    <i class="bi bi-x-circle me-1"></i> Cancel
                                </a>
                                <button type="submit" class="btn btn-primary px-4">
                                    <i class="bi bi-person-plus me-1"></i> Register Student
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Right Column - Help & Preview -->
        <div class="col-lg-4">
            <!-- Help Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0 py-3">
                    <h6 class="mb-0 fw-bold">
                        <i class="bi bi-info-circle text-info me-2"></i>
                        Important Information
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-3">
                            <div class="d-flex">
                                <i class="bi bi-envelope-check-fill text-primary me-2 mt-1"></i>
                                <div>
                                    <small class="fw-medium d-block">Email Required</small>
                                    <small class="text-muted">Student email is mandatory for sending credentials</small>
                                </div>
                            </div>
                        </li>
                        <li class="mb-3">
                            <div class="d-flex">
                                <i class="bi bi-key-fill text-warning me-2 mt-1"></i>
                                <div>
                                    <small class="fw-medium d-block">Auto-generated Credentials</small>
                                    <small class="text-muted">Username: Registration Number</small><br>
                                    <small class="text-muted">Password: firstname@123</small>
                                </div>
                            </div>
                        </li>
                        <li class="mb-3">
                            <div class="d-flex">
                                <i class="bi bi-shield-check text-success me-2 mt-1"></i>
                                <div>
                                    <small class="fw-medium d-block">Secure Registration</small>
                                    <small class="text-muted">All data is encrypted and securely stored</small>
                                </div>
                            </div>
                        </li>
                        <li>
                            <div class="d-flex">
                                <i class="bi bi-lightning-charge text-danger me-2 mt-1"></i>
                                <div>
                                    <small class="fw-medium d-block">Instant Email Delivery</small>
                                    <small class="text-muted">Credentials are sent immediately after registration</small>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- Preview Card -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3">
                    <h6 class="mb-0 fw-bold">
                        <i class="bi bi-eye text-primary me-2"></i>
                        Student Preview
                    </h6>
                </div>
                <div class="card-body text-center">
                    <div class="mb-3">
                        <!-- Photo Preview -->
                        <div class="avatar-preview bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" 
                             style="width: 100px; height: 100px; overflow: hidden; border: 2px solid #e0e0e0;">
                            <img src="" alt="Preview" id="photoPreview" style="display: none; width: 100%; height: 100%; object-fit: cover;">
                            <span class="text-primary fs-2 fw-bold" id="avatarInitial">S</span>
                        </div>
                        <h5 id="previewName" class="fw-bold mb-1">Student Name</h5>
                        <p class="text-muted mb-2" id="previewClass">Not Assigned</p>
                        <p class="text-muted mb-0" id="previewEmail">email@example.com</p>
                    </div>
                    
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="p-2 bg-light rounded">
                                <small class="text-muted d-block">Status</small>
                                <span class="badge bg-success" id="previewStatus">Active</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-2 bg-light rounded">
                                <small class="text-muted d-block">Admission Year</small>
                                <small class="fw-medium" id="previewYear">{{ current_year }}</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Credentials Preview -->
                    <div class="mt-3 p-3 bg-light rounded">
                        <small class="text-muted d-block mb-2">Login Credentials:</small>
                        <div class="text-start">
                            <small class="d-block">
                                <i class="bi bi-person-badge me-1"></i>
                                Username: <code id="previewUsername">REG-NUMBER</code>
                            </small>
                            <small class="d-block mt-1">
                                <i class="bi bi-key me-1"></i>
                                Password: <code id="previewPassword">firstname@123</code>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Email Status Card -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                        <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                            <i class="bi bi-envelope-paper text-primary"></i>
                        </div>
                        <div>
                            <small class="text-muted d-block">Email Status</small>
                            <h5 class="fw-bold mb-0">
                                <span id="emailStatus" class="text-success">Ready to Send</span>
                            </h5>
                        </div>
                    </div>
                    <small class="text-muted d-block mt-2">
                        <i class="bi bi-info-circle me-1"></i>
                        Credentials will be sent to: <span id="targetEmail">-</span>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Custom Styles */
    .card {
        transition: transform 0.2s ease;
    }
    
    .card:hover {
        transform: translateY(-2px);
    }
    
    .avatar-preview {
        transition: all 0.3s ease;
        position: relative;
    }
    
    .form-control, .form-select {
        border: 1px solid #e0e0e0;
        transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #4361ee;
        box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
    }
    
    .form-label {
        font-weight: 500;
        color: #495057;
    }
    
    .input-group-text {
        background-color: #f8f9fa;
        border-right: none;
    }
    
    .input-group .form-control {
        border-left: none;
    }
    
    .input-group .form-control:focus {
        border-left: 1px solid #4361ee;
    }
    
    /* Validation styles */
    .was-validated .form-control:invalid,
    .was-validated .form-select:invalid {
        border-color: #dc3545;
    }
    
    .was-validated .form-control:valid,
    .was-validated .form-select:valid {
        border-color: #198754;
    }
    
    /* Credential preview styles */
    code {
        font-family: 'Courier New', monospace;
        background: #f8f9fa;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.9em;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .card-body {
            padding: 1.5rem !important;
        }
        
        .btn {
            width: 100%;
            margin-bottom: 0.5rem;
        }
        
        .row.g-3 > .col-md-12,
        .row.g-3 > .col-md-6 {
            margin-bottom: 1rem;
        }
    }
    
    @media (max-width: 576px) {
        .d-flex.justify-content-between {
            flex-direction: column;
            align-items: flex-start !important;
        }
        
        .d-flex.justify-content-between > div {
            margin-bottom: 1rem;
        }
        
        .btn-group {
            flex-direction: column;
            width: 100%;
        }
        
        .btn-group .btn {
            width: 100%;
            margin-bottom: 0.5rem;
        }
    }
</style>

<script>
    // DOM ready function
    document.addEventListener('DOMContentLoaded', function() {
        initializeFormValidation();
        setupLivePreview();
        setupFormListeners();
        generateRegistrationPreview();
    });

    function initializeFormValidation() {
        const form = document.getElementById('studentForm');
        
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            form.classList.add('was-validated');
            
            // If form is valid, show loading state
            if (form.checkValidity()) {
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Registering...';
                submitBtn.disabled = true;
                
                // Reset button after 5 seconds (in case submission fails)
                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }, 5000);
            }
        }, false);
    }

    function setupLivePreview() {
        const nameInput = document.getElementById('full_name');
        const emailInput = document.getElementById('email');
        const classSelect = document.getElementById('classroom');
        const yearSelect = document.getElementById('admission_year');
        const statusSelect = document.getElementById('status');
        const photoInput = document.getElementById('photo');
        
        // Name preview and password generation
        if (nameInput) {
            nameInput.addEventListener('input', function() {
                const previewName = document.getElementById('previewName');
                const avatarInitial = document.getElementById('avatarInitial');
                const passwordPreview = document.getElementById('passwordPreview');
                const previewPassword = document.getElementById('previewPassword');
                
                if (this.value.trim()) {
                    previewName.textContent = this.value;
                    // Get first letter for avatar
                    avatarInitial.textContent = this.value.charAt(0).toUpperCase();
                    
                    // Generate password preview
                    const firstName = this.value.split(' ')[0].toLowerCase();
                    const password = `${firstName}@123`;
                    passwordPreview.textContent = password;
                    previewPassword.textContent = password;
                } else {
                    previewName.textContent = 'Student Name';
                    avatarInitial.textContent = 'S';
                    passwordPreview.textContent = 'firstname@123';
                    previewPassword.textContent = 'firstname@123';
                }
                
                // Update registration preview if needed
                generateRegistrationPreview();
            });
        }
        
        // Email preview
        if (emailInput) {
            emailInput.addEventListener('input', function() {
                const previewEmail = document.getElementById('previewEmail');
                const targetEmail = document.getElementById('targetEmail');
                
                if (this.value.trim()) {
                    previewEmail.textContent = this.value;
                    targetEmail.textContent = this.value;
                    document.getElementById('emailStatus').textContent = 'Ready to Send';
                    document.getElementById('emailStatus').className = 'text-success';
                } else {
                    previewEmail.textContent = 'email@example.com';
                    targetEmail.textContent = '-';
                    document.getElementById('emailStatus').textContent = 'Email Required';
                    document.getElementById('emailStatus').className = 'text-danger';
                }
            });
        }
        
        // Class preview
        if (classSelect) {
            classSelect.addEventListener('change', function() {
                const previewClass = document.getElementById('previewClass');
                const selectedOption = this.options[this.selectedIndex];
                
                if (this.value) {
                    previewClass.textContent = selectedOption.text;
                    generateRegistrationPreview();
                } else {
                    previewClass.textContent = 'Not Assigned';
                }
            });
        }
        
        // Year preview
        if (yearSelect) {
            yearSelect.addEventListener('change', function() {
                const previewYear = document.getElementById('previewYear');
                if (this.value) {
                    previewYear.textContent = this.value;
                    generateRegistrationPreview();
                }
            });
        }
        
        // Status preview
        if (statusSelect) {
            statusSelect.addEventListener('change', function() {
                const previewStatus = document.getElementById('previewStatus');
                const badge = previewStatus;
                
                // Update badge color based on status
                switch(this.value) {
                    case 'ACTIVE':
                        badge.className = 'badge bg-success';
                        badge.textContent = 'Active';
                        break;
                    case 'GRADUATED':
                        badge.className = 'badge bg-info';
                        badge.textContent = 'Graduated';
                        break;
                    case 'TRANSFERRED':
                        badge.className = 'badge bg-warning';
                        badge.textContent = 'Transferred';
                        break;
                    default:
                        badge.className = 'badge bg-secondary';
                        badge.textContent = this.value;
                }
            });
        }
        
        // Photo preview
        if (photoInput) {
            photoInput.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById('photoPreview');
                        const avatarInitial = document.getElementById('avatarInitial');
                        
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                        avatarInitial.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
    }

    function generateRegistrationPreview() {
        const classSelect = document.getElementById('classroom');
        const yearSelect = document.getElementById('admission_year');
        const regPreview = document.getElementById('registrationPreview');
        const usernamePreview = document.getElementById('previewUsername');
        
        if (!classSelect.value || !yearSelect.value) {
            regPreview.textContent = 'CA/CLASS/YEAR/0001';
            usernamePreview.textContent = 'REG-NUMBER';
            return;
        }
        
        // Get class code
        const selectedClass = classSelect.options[classSelect.selectedIndex];
        const classText = selectedClass.text;
        const classCode = classText.match(/\(([^)]+)\)/);
        const code = classCode ? classCode[1] : 'GEN';
        
        // Get year
        const year = yearSelect.value;
        
        // Generate registration number format
        const regNumber = `CA/${code}/${year}/0001`;
        regPreview.textContent = regNumber;
        usernamePreview.textContent = regNumber;
    }

    function setupFormListeners() {
        // Refresh registration preview button
        const generateRegBtn = document.getElementById('generateRegBtn');
        if (generateRegBtn) {
            generateRegBtn.addEventListener('click', function() {
                generateRegistrationPreview();
                showToast('Registration preview refreshed!', 'info');
            });
        }
        
        // Auto-save draft functionality
        let saveTimeout;
        const form = document.getElementById('studentForm');
        
        if (form) {
            form.addEventListener('input', function() {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(function() {
                    const formData = new FormData(form);
                    const data = {};
                    formData.forEach((value, key) => {
                        data[key] = value;
                    });
                    
                    // Save to localStorage
                    localStorage.setItem('studentFormDraft', JSON.stringify(data));
                    
                    // Show auto-save indicator
                    showAutoSaveIndicator();
                }, 1000);
            });
            
            // Load draft on page load
            loadFormDraft();
            
            // Clear draft on successful submit
            form.addEventListener('submit', function() {
                localStorage.removeItem('studentFormDraft');
            });
        }
        
        // Email validation
        const emailInput = document.getElementById('email');
        if (emailInput) {
            emailInput.addEventListener('blur', function() {
                const email = this.value.trim();
                if (email && !isValidEmail(email)) {
                    this.classList.add('is-invalid');
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'invalid-feedback';
                    errorDiv.textContent = 'Please enter a valid email address';
                    this.parentNode.appendChild(errorDiv);
                }
            });
            
            emailInput.addEventListener('input', function() {
                this.classList.remove('is-invalid');
                const errorDiv = this.parentNode.querySelector('.invalid-feedback');
                if (errorDiv) {
                    errorDiv.remove();
                }
            });
        }
        
        // Toggle email sending
        const emailToggle = document.getElementById('sendEmailToggle');
        if (emailToggle) {
            emailToggle.addEventListener('change', function() {
                const emailStatus = document.getElementById('emailStatus');
                if (this.checked) {
                    emailStatus.textContent = 'Ready to Send';
                    emailStatus.className = 'text-success';
                } else {
                    emailStatus.textContent = 'Email Disabled';
                    emailStatus.className = 'text-muted';
                }
            });
        }
    }

    function loadFormDraft() {
        const draft = localStorage.getItem('studentFormDraft');
        if (draft) {
            try {
                const data = JSON.parse(draft);
                const form = document.getElementById('studentForm');
                
                for (const key in data) {
                    const element = form.querySelector(`[name="${key}"]`);
                    if (element && data[key] && element.type !== 'file') {
                        element.value = data[key];
                        
                        // Trigger change events for preview
                        if (element.dispatchEvent) {
                            element.dispatchEvent(new Event('input'));
                            element.dispatchEvent(new Event('change'));
                        }
                    }
                }
                
                // Show draft loaded message
                setTimeout(() => {
                    showToast('Form restored from previous session', 'info');
                }, 500);
            } catch (e) {
                console.error('Error loading draft:', e);
            }
        }
    }

    function showAutoSaveIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'position-fixed';
        indicator.style.cssText = 'bottom: 20px; right: 20px; z-index: 9999;';
        indicator.innerHTML = `
            <div class="toast show" role="alert">
                <div class="toast-header bg-success text-white">
                    <i class="bi bi-save me-2"></i>
                    <strong class="me-auto">Auto-saved</strong>
                    <small>Just now</small>
                </div>
                <div class="toast-body">
                    Form draft saved locally
                </div>
            </div>
        `;
        
        const existingIndicator = document.querySelector('.position-fixed[style*="bottom: 20px; right: 20px"]');
        if (existingIndicator) {
            existingIndicator.remove();
        }
        
        document.body.appendChild(indicator);
        
        // Remove indicator after 3 seconds
        setTimeout(() => {
            if (indicator.parentNode) {
                indicator.remove();
            }
        }, 3000);
    }

    function isValidEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    }

    function showToast(message, type = 'info') {
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type} border-0 position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi ${type === 'success' ? 'bi-check-circle' : 
                                  type === 'warning' ? 'bi-exclamation-triangle' : 
                                  type === 'danger' ? 'bi-x-circle' : 'bi-info-circle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Initialize and show toast
        const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
        bsToast.show();
        
        // Remove toast after hiding
        toast.addEventListener('hidden.bs.toast', function() {
            document.body.removeChild(toast);
        });
    }
    
    // Generate years for admission year dropdown
    function generateYearOptions() {
        const yearSelect = document.getElementById('admission_year');
        if (yearSelect) {
            const currentYear = new Date().getFullYear();
            const startYear = currentYear - 10;
            
            for (let year = currentYear; year >= startYear; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }
        }
    }
    
    // Call year generation on load
    generateYearOptions();
</script>
{% endblock %}