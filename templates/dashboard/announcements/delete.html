{% extends 'base.html' %}
{% load static %}

{% block title %}Delete Announcement - Charles Academy SMS{% endblock %}
{% block page_title %}Delete Announcement{% endblock %}

{% block content %}
<div class="container-fluid px-0 px-md-2">
    <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8 col-xl-6">
            <!-- Mobile Header -->
            <div class="d-md-none mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h4 fw-bold mb-1 text-danger">
                            <i class="bi bi-trash3 me-2"></i>Delete Announcement
                        </h1>
                        <nav aria-label="breadcrumb" class="d-none">
                            <ol class="breadcrumb mb-0">
                                <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Home</a></li>
                                <li class="breadcrumb-item"><a href="{% url 'announcement_list' %}">Announcements</a></li>
                                <li class="breadcrumb-item"><a href="{% url 'announcement_detail' announcement.pk %}">Details</a></li>
                                <li class="breadcrumb-item active">Delete</li>
                            </ol>
                        </nav>
                    </div>
                    <a href="{% url 'announcement_detail' announcement.pk %}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-arrow-left"></i>
                        <span class="d-none d-sm-inline">Back</span>
                    </a>
                </div>
            </div>

            <!-- Main Deletion Card -->
            <div class="card shadow-lg border-danger">
                <!-- Desktop Header -->
                <div class="card-header bg-danger text-white d-none d-md-block py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-exclamation-octagon me-2"></i>
                            Confirm Deletion
                        </h5>
                        <a href="{% url 'announcement_detail' announcement.pk %}" class="btn btn-sm btn-light">
                            <i class="bi bi-arrow-left me-1"></i> Back
                        </a>
                    </div>
                </div>
                
                <!-- Mobile Header inside card -->
                <div class="card-header bg-danger text-white d-md-none py-3">
                    <h5 class="mb-0 text-center">
                        <i class="bi bi-exclamation-octagon me-2"></i>
                        Confirm Deletion
                    </h5>
                </div>
                
                <div class="card-body p-3 p-md-4">
                    <!-- Warning Banner -->
                    <div class="alert alert-danger border-danger mb-4">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="bi bi-exclamation-triangle-fill fs-3"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="alert-heading mb-1">Irreversible Action</h6>
                                <p class="mb-0 small">This announcement will be permanently deleted and cannot be recovered.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Announcement Preview -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0 fw-bold text-muted">Announcement to Delete:</h6>
                            <span class="badge bg-danger">ID: {{ announcement.pk|stringformat:"04d" }}</span>
                        </div>
                        <div class="announcement-preview p-3 border border-danger rounded bg-danger bg-opacity-5">
                            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-2 mb-2">
                                <h6 class="mb-0 fw-bold text-danger">
                                    <i class="bi bi-megaphone me-1"></i>
                                    {{ announcement.title|truncatechars:50 }}
                                </h6>
                                <small class="text-muted text-nowrap">
                                    <i class="bi bi-calendar me-1"></i>
                                    {{ announcement.created_at|date:"M d, Y" }}
                                </small>
                            </div>
                            <p class="text-muted mb-2 small">
                                {{ announcement.message|truncatewords:25 }}
                            </p>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="bi bi-clock me-1"></i>
                                    {{ announcement.created_at|timesince }} ago
                                </small>
                                <small class="text-muted">
                                    <i class="bi bi-text-paragraph me-1"></i>
                                    {{ announcement.message|wordcount }} words
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Warning Messages -->
                    <div class="alert alert-warning border-warning mb-4">
                        <div class="d-flex">
                            <i class="bi bi-shield-exclamation flex-shrink-0 me-3 fs-4"></i>
                            <div>
                                <strong class="d-block mb-1">Final Warning</strong>
                                <p class="mb-2 small">Deleting this announcement will:</p>
                                <ul class="mb-0 small ps-3">
                                    <li>Remove it from all user dashboards</li>
                                    <li>Delete associated notifications</li>
                                    <li>Cannot be undone or recovered</li>
                                    <li>Affect all users who can see this announcement</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Confirmation Checkboxes -->
                    <div class="mb-4">
                        <h6 class="mb-3 fw-bold">
                            <i class="bi bi-check2-square me-2"></i>
                            Confirm All Statements:
                        </h6>
                        <div class="confirmation-list">
                            <div class="form-check confirmation-item mb-3 p-3 border rounded">
                                <input class="form-check-input" type="checkbox" id="confirmDelete">
                                <label class="form-check-label d-flex align-items-center" for="confirmDelete">
                                    <span class="flex-grow-1">
                                        <strong class="d-block">I understand this action is permanent</strong>
                                        <small class="text-muted">This announcement will be permanently removed from the system</small>
                                    </span>
                                    <i class="bi bi-shield-check text-success ms-2"></i>
                                </label>
                            </div>
                            
                            <div class="form-check confirmation-item mb-3 p-3 border rounded">
                                <input class="form-check-input" type="checkbox" id="confirmNoBackup">
                                <label class="form-check-label d-flex align-items-center" for="confirmNoBackup">
                                    <span class="flex-grow-1">
                                        <strong class="d-block">I have backed up important information</strong>
                                        <small class="text-muted">Any critical information has been saved elsewhere</small>
                                    </span>
                                    <i class="bi bi-cloud-check text-primary ms-2"></i>
                                </label>
                            </div>
                            
                            <div class="form-check confirmation-item mb-3 p-3 border rounded">
                                <input class="form-check-input" type="checkbox" id="confirmAuthority">
                                <label class="form-check-label d-flex align-items-center" for="confirmAuthority">
                                    <span class="flex-grow-1">
                                        <strong class="d-block">I have authority to delete this</strong>
                                        <small class="text-muted">I am authorized to perform this deletion</small>
                                    </span>
                                    <i class="bi bi-person-check text-warning ms-2"></i>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Deletion Form -->
                    <form method="post" id="deleteForm" class="mt-4 pt-3 border-top">
                        {% csrf_token %}
                        
                        <!-- Optional Reason for Deletion -->
                        <div class="mb-4">
                            <label for="deletionReason" class="form-label fw-bold">
                                <i class="bi bi-card-text me-1"></i>
                                Reason for Deletion (Optional)
                            </label>
                            <textarea class="form-control" 
                                      id="deletionReason" 
                                      name="deletion_reason" 
                                      rows="2"
                                      placeholder="Briefly explain why you're deleting this announcement..."
                                      maxlength="500"></textarea>
                            <div class="form-text text-end">
                                <span id="reasonCharCount">0</span>/500 characters
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="d-flex flex-column flex-md-row justify-content-between align-items-stretch align-items-md-center gap-3">
                            <div class="order-2 order-md-1 d-grid">
                                <a href="{% url 'announcement_detail' announcement.pk %}" 
                                   class="btn btn-lg btn-outline-secondary">
                                    <i class="bi bi-x-circle me-2"></i>
                                    Cancel
                                </a>
                            </div>
                            <div class="order-1 order-md-2 d-grid">
                                <button type="submit" 
                                        class="btn btn-lg btn-danger" 
                                        id="deleteButton"
                                        disabled>
                                    <span id="buttonText">
                                        <i class="bi bi-trash3 me-2"></i>
                                        Delete Announcement
                                    </span>
                                    <span id="buttonLoader" class="d-none">
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                        Deleting...
                                    </span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Mobile Warning -->
                        <div class="d-md-none alert alert-light border mt-3 text-center">
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                All checkboxes must be checked to enable delete
                            </small>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Statistics Card -->
            <div class="card shadow border-0 mt-3">
                <div class="card-header bg-light border-0 py-3">
                    <h6 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        Announcement Information
                    </h6>
                </div>
                <div class="card-body p-3">
                    <div class="row row-cols-2 row-cols-md-4 g-3">
                        <div class="col">
                            <div class="text-center p-2 border rounded h-100">
                                <div class="fs-4 fw-bold text-primary mb-1">
                                    {{ announcement.created_at|timesince|split:","|first }}
                                </div>
                                <small class="text-muted">Days Old</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="text-center p-2 border rounded h-100">
                                <div class="fs-4 fw-bold text-success mb-1">
                                    {{ announcement.pk|stringformat:"04d" }}
                                </div>
                                <small class="text-muted">Announcement ID</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="text-center p-2 border rounded h-100">
                                <div class="fs-4 fw-bold text-warning mb-1">
                                    {{ announcement.message|wordcount }}
                                </div>
                                <small class="text-muted">Words</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="text-center p-2 border rounded h-100">
                                <div class="fs-4 fw-bold text-info mb-1">
                                    {{ announcement.message|length }}
                                </div>
                                <small class="text-muted">Characters</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Additional Info -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="d-flex flex-wrap gap-2">
                                <span class="badge bg-secondary">
                                    <i class="bi bi-person me-1"></i>
                                    {{ announcement.created_by.get_full_name|default:announcement.created_by.username }}
                                </span>
                                <span class="badge bg-secondary">
                                    <i class="bi bi-calendar3 me-1"></i>
                                    {{ announcement.created_at|date:"Y-m-d" }}
                                </span>
                                <span class="badge bg-secondary">
                                    <i class="bi bi-clock me-1"></i>
                                    {{ announcement.created_at|time:"H:i" }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Safety Notice -->
            <div class="card shadow border-warning mt-3">
                <div class="card-body p-3 text-center">
                    <div class="d-flex align-items-center justify-content-center gap-2">
                        <i class="bi bi-shield-check text-warning fs-4"></i>
                        <div>
                            <small class="text-muted">
                                For safety, consider <a href="{% url 'announcement_detail' announcement.pk %}">archiving</a> 
                                instead of deleting if this information might be needed later.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const confirmDelete = document.getElementById('confirmDelete');
    const confirmNoBackup = document.getElementById('confirmNoBackup');
    const confirmAuthority = document.getElementById('confirmAuthority');
    const deleteButton = document.getElementById('deleteButton');
    const deleteForm = document.getElementById('deleteForm');
    const deletionReason = document.getElementById('deletionReason');
    const reasonCharCount = document.getElementById('reasonCharCount');
    const buttonText = document.getElementById('buttonText');
    const buttonLoader = document.getElementById('buttonLoader');
    
    // Initialize character count
    if (deletionReason && reasonCharCount) {
        reasonCharCount.textContent = deletionReason.value.length;
        deletionReason.addEventListener('input', function() {
            reasonCharCount.textContent = this.value.length;
            if (this.value.length >= 450) {
                reasonCharCount.classList.add('text-warning');
                if (this.value.length >= 500) {
                    reasonCharCount.classList.remove('text-warning');
                    reasonCharCount.classList.add('text-danger');
                }
            } else {
                reasonCharCount.classList.remove('text-warning', 'text-danger');
            }
        });
    }
    
    // Enable/disable delete button based on checkboxes
    function updateDeleteButton() {
        const allChecked = confirmDelete.checked && 
                          confirmNoBackup.checked && 
                          confirmAuthority.checked;
        
        if (allChecked) {
            deleteButton.disabled = false;
            deleteButton.classList.remove('btn-danger-disabled');
            deleteButton.classList.add('btn-danger-active');
            
            // Update button text
            buttonText.innerHTML = '<i class="bi bi-trash3-fill me-2"></i>Confirm Deletion';
        } else {
            deleteButton.disabled = true;
            deleteButton.classList.remove('btn-danger-active');
            deleteButton.classList.add('btn-danger-disabled');
            
            // Update button text
            buttonText.innerHTML = '<i class="bi bi-trash3 me-2"></i>Delete Announcement';
        }
    }
    
    // Add event listeners to checkboxes
    [confirmDelete, confirmNoBackup, confirmAuthority].forEach(checkbox => {
        checkbox.addEventListener('change', updateDeleteButton);
        
        // Add visual feedback on change
        checkbox.addEventListener('change', function() {
            const parent = this.closest('.confirmation-item');
            if (this.checked) {
                parent.classList.add('border-success', 'bg-success-bg');
                parent.classList.remove('border-danger');
            } else {
                parent.classList.remove('border-success', 'bg-success-bg');
            }
        });
    });
    
    // Form submission with confirmation
    if (deleteForm) {
        deleteForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Validate all checkboxes are checked
            if (!confirmDelete.checked || !confirmNoBackup.checked || !confirmAuthority.checked) {
                showAlert('Please confirm all statements before deleting.', 'warning');
                
                // Scroll to first unchecked checkbox
                const unchecked = [confirmDelete, confirmNoBackup, confirmAuthority]
                    .find(cb => !cb.checked);
                if (unchecked) {
                    unchecked.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    unchecked.focus();
                }
                return;
            }
            
            // Show final confirmation modal/dialog
            showConfirmationDialog();
        });
    }
    
    // Final confirmation dialog
    function showConfirmationDialog() {
        const modalHtml = `
            <div class="modal fade" id="finalConfirmationModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-danger">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">
                                <i class="bi bi-exclamation-octagon-fill me-2"></i>
                                Final Confirmation
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="text-center mb-4">
                                <i class="bi bi-shield-exclamation text-danger" style="font-size: 3.5rem;"></i>
                                <h4 class="mt-3 text-danger fw-bold">Are you absolutely sure?</h4>
                            </div>
                            
                            <div class="alert alert-danger">
                                <p class="mb-2"><strong>This is your last chance to cancel.</strong></p>
                                <p class="mb-0 small">Once deleted, this announcement cannot be recovered under any circumstances.</p>
                            </div>
                            
                            <div class="form-check mt-3">
                                <input class="form-check-input" type="checkbox" id="finalConfirm">
                                <label class="form-check-label text-muted" for="finalConfirm">
                                    I understand and accept that this deletion is permanent
                                </label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="bi bi-x-circle me-2"></i>Cancel
                            </button>
                            <button type="button" class="btn btn-danger" id="finalDeleteBtn" disabled>
                                <i class="bi bi-trash3-fill me-2"></i>Yes, Delete Permanently
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Add modal to DOM
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        const modal = new bootstrap.Modal(document.getElementById('finalConfirmationModal'));
        
        // Show modal
        modal.show();
        
        // Handle final confirmation checkbox
        const finalConfirm = document.getElementById('finalConfirm');
        const finalDeleteBtn = document.getElementById('finalDeleteBtn');
        
        finalConfirm.addEventListener('change', function() {
            finalDeleteBtn.disabled = !this.checked;
        });
        
        // Handle final delete button click
        finalDeleteBtn.addEventListener('click', function() {
            // Show loading state
            buttonText.classList.add('d-none');
            buttonLoader.classList.remove('d-none');
            deleteButton.disabled = true;
            
            // Close modal
            modal.hide();
            
            // Submit form after delay
            setTimeout(() => {
                deleteForm.submit();
            }, 500);
        });
        
        // Clean up modal on hide
        document.getElementById('finalConfirmationModal').addEventListener('hidden.bs.modal', function() {
            this.remove();
        });
    }
    
    // Show alert function
    function showAlert(message, type = 'info') {
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show position-fixed bottom-0 end-0 m-3" 
                 style="z-index: 1060; max-width: 350px;" role="alert">
                <div class="d-flex align-items-center">
                    <i class="bi bi-${type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    <div>${message}</div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', alertHtml);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            const alert = document.querySelector('.alert[role="alert"]');
            if (alert) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }
        }, 5000);
    }
    
    // Prevent accidental back/refresh
    let formChanged = false;
    const formInputs = deleteForm.querySelectorAll('input, textarea');
    
    formInputs.forEach(input => {
        input.addEventListener('input', () => {
            formChanged = true;
        });
    });
    
    window.addEventListener('beforeunload', function(e) {
        if (formChanged && !deleteButton.disabled) {
            e.preventDefault();
            e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
            return e.returnValue;
        }
    });
    
    // Initialize button state
    updateDeleteButton();
});

// Add visual effects for checkboxes
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.form-check-input');
    
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const icon = this.parentElement.querySelector('.bi');
            if (icon) {
                if (this.checked) {
                    icon.classList.remove('bi-shield', 'bi-cloud', 'bi-person');
                    icon.classList.add('bi-shield-check', 'bi-cloud-check', 'bi-person-check');
                    icon.classList.add('animate-icon');
                    
                    // Remove animation class after animation completes
                    setTimeout(() => {
                        icon.classList.remove('animate-icon');
                    }, 500);
                } else {
                    icon.classList.remove('bi-shield-check', 'bi-cloud-check', 'bi-person-check');
                    icon.classList.add('bi-shield', 'bi-cloud', 'bi-person');
                }
            }
        });
    });
});
</script>

<style>
/* Custom styles for deletion page */
.card.border-danger {
    border-width: 2px;
    border-style: solid;
}

.announcement-preview {
    border-left-width: 4px !important;
    transition: all 0.3s ease;
}

.confirmation-item {
    transition: all 0.3s ease;
    cursor: pointer;
}

.confirmation-item:hover {
    transform: translateX(5px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.confirmation-item.border-success {
    border-color: #198754 !important;
    background-color: rgba(25, 135, 84, 0.05) !important;
}

.btn-danger-disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn-danger-active {
    box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.5);
    animation: pulse-danger 2s infinite;
}

@keyframes pulse-danger {
    0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.5); }
    70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
}

.animate-icon {
    animation: bounce 0.5s ease;
}

@keyframes bounce {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
}

/* Responsive adjustments */
@media (max-width: 767.98px) {
    .card-body {
        padding: 1.25rem !important;
    }
    
    .confirmation-item {
        padding: 1rem !important;
    }
    
    .btn-lg {
        padding: 0.75rem 1rem !important;
        font-size: 0.95rem !important;
    }
    
    .announcement-preview {
        padding: 1rem !important;
    }
    
    .modal-dialog {
        margin: 0.5rem !important;
    }
}

@media (max-width: 575.98px) {
    .container-fluid {
        padding-left: 10px !important;
        padding-right: 10px !important;
    }
    
    .card-header {
        padding: 1rem !important;
    }
    
    .row-cols-2 > .col {
        padding: 0.5rem !important;
    }
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .announcement-preview {
        background-color: rgba(220, 53, 69, 0.1) !important;
    }
    
    .confirmation-item {
        background-color: #2d3748 !important;
        border-color: #4a5568 !important;
    }
    
    .confirmation-item.border-success {
        background-color: rgba(25, 135, 84, 0.2) !important;
    }
}

/* Touch-friendly improvements */
.form-check-input {
    width: 1.2em;
    height: 1.2em;
    margin-top: 0.2em;
}

.btn, .form-check-label {
    -webkit-tap-highlight-color: transparent;
}

.btn:active {
    transform: scale(0.98);
}
</style>
{% endblock %}